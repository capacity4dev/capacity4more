<?php
/**
 * @file
 * Code for group blocks.
 */

/**
 * Function to preprocess a block.
 *
 * We set classes here to avoid another wrapper div within the block.
 *
 * @param array $variables
 *   Block variables.
 */
function _c4m_content_group_preprocess_header_name_banner(array &$variables) {
  // First establish the current group.
  $group = c4m_og_current_group();

  $group_access = c4m_og_get_access_type($group);
  if (!empty($group_access['type'])) {
    $variables['classes_array'][] = 'group-' .
      drupal_html_class($group_access['type']);
  }
}
/**
 * The group name.
 */
function _c4m_content_group_block_header_name_banner() {
  // First establish the current group.
  $group = c4m_og_current_group();
  $wrapper = entity_metadata_wrapper('node', $group);

  $title = $wrapper->title->value();
  $status = $wrapper->c4m_og_status->value();
  $tag['title']['element'] = array(
    '#tag' => 'h1',
    '#attributes' => array(
      'class' => array('group-title'),
    ),
    '#value' => $title,
  );

  $markup = theme_html_tag($tag['title']);

  if ($status != 'published') {
    $tag['status']['element'] = array(
      '#tag' => 'span',
      '#attributes' => array(
        'class' => array('group-status'),
      ),
      '#value' => $status,
    );
    $markup .= theme_html_tag($tag['status']);
  }

  if (drupal_is_front_page()) {
    // Add group image.
    $file = $wrapper->c4m_banner->value();
    if (!empty($file)) {
      $file['style_name'] = 'banner';
      $file['path'] = $file['uri'];
      $file['attributes'] = array('class' => 'group-banner');
      $markup .= theme_image_style($file);
    }
  }

  // If current page is the Group Management page and user has 'administer group' access,
  // Print an edit link (In the block where the banner should be).
  if (current_path() == 'manage' && og_user_access($wrapper->type(), $wrapper->getIdentifier(), 'administer group')) {
    $edit_link = l(t('Edit'), url('node/' . $group->nid . '/edit', array('absolute' => TRUE)));
    $tag['element'] = array(
      '#tag' => 'div',
      '#attributes' => array(
        'class' => array('edit-banner'),
      ),
      '#value' => $edit_link,
    );
    $markup .= theme_html_tag($tag);
  }

  return array(
    'subject' => '',
    'content' => $markup,
  );
}
