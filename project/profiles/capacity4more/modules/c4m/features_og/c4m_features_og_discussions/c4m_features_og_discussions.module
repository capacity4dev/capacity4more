<?php

/**
 * @file
 * Code for the Group Discussions feature.
 */

include_once 'c4m_features_og_discussions.features.inc';

/**
 * Implements hook_c4m_og_feature_info().
 */
function c4m_features_og_discussions_c4m_og_feature_info() {
  return array(
    'c4m_features_og_discussions' => array(
      'name' => t('Discussions'),
      'description' => t('Discussions overview.'),
      'machine_name' => 'c4m_features_og_discussions',
      'weight' => 2,
      'default' => TRUE,
      'group_types' => array('group', 'project'),
      'content_types' => array('discussion'),
    ),
  );
}

/**
 * Implements hook_preprocess().
 *
 * Add an icon to the "Add a new Discussion" button
 * that appears in the discussion related views.
 */
function c4m_features_og_discussions_preprocess_views_view(&$variables) {
  if (!in_array($variables['name'], array('c4m_overview_og_discussions_landing', 'c4m_overview_og_discussions'))) {
    // Not an discussion related view.
    return;
  }

  if (!in_array($variables['display_id'], array('page', 'page_1'))) {
    // Not a "page" display.
    return;
  }

  $og_context = og_context();

  if (!og_user_access($og_context['group_type'], $og_context['gid'], 'create discussion content')) {
    // User doesn't have permission to create a new discussion.
    $variables['header'] = '';
    return;
  }

  $icon = '<i class="fa fa-pencil" aria-hidden="true"></i>';
  $text = t('Add a new Discussion');
  $variables['header'] = str_replace($text, $icon . ' ' . $text, $variables['header']);
}
