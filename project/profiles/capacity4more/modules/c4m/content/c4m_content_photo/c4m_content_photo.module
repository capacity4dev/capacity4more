<?php
/**
 * @file
 * Code for the Photo content type feature.
 */

include_once 'c4m_content_photo.features.inc';

/**
 * Implements hook_theme_registry_alter().
 */
function c4m_content_photo_theme_registry_alter(&$theme_registry) {
  $theme_registry['node_gallery_api_item_navigator']['path'] = drupal_get_path('module', 'c4m_content_photo') . "/theme";
}

/**
 * Implements hook_c4m_helper_entity_metrics_info().
 */
function c4m_content_photo_c4m_helper_entity_metrics_info() {
  return array(
    'c4m_og_photos' => array(
      'type'      => 'photo',
      'context'   => 'group',
      'callback'  => 'c4m_og_group_node_metric',
      'arguments' => array(array('photo')),
      'weight'    => 2,
    ),
  );
}

/**
 * Implements hook_c4m_content_share_fields_info().
 */
function c4m_content_photo_c4m_content_share_fields_info() {
  return array(
    'photo' => array(
      'type',
    ),
  );
}

/**
 * Implements hook_c4m_helper_entity_label_info().
 */
function c4m_content_photo_c4m_helper_entity_label_info() {
  return array(
    'photo' => array(
      'article' => t('a'),
      'singular' => t('photo'),
      'plural' => t('photos'),
      'insert action' => t('uploaded a new photo'),
      'update action' => t('updated the photo'),
      'icon' => 'fa-file-picture-o',
    ),
  );
}

/**
 * Implements hook_node_insert().
 *
 * If a photo was uploaded and if it is part of a photo album
 * rename the file as Album name + number.
 */
function c4m_content_photo_node_insert($node) {
  if ($node->type != 'photo') {
    return;
  }
  if (empty($node->node_gallery_ref_1)) {
    return;
  }

  $wrapper = entity_metadata_wrapper('node', $node);

  $source = file_load($wrapper->c4m_media->value()['fid']);
  $gallery_title = $wrapper->node_gallery_ref_1->label();
  $path = substr($source->uri, 0, strrpos($source->uri, "/"));
  $destination = format_string('@path/@filename', array(
    '@path' => $path,
    '@filename' => transliteration_clean_filename($gallery_title),
  ));

  file_move($source, $destination, FILE_EXISTS_RENAME);
}
